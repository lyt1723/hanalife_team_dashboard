<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ë‚˜ìƒëª… ì´ì •í™” ì§€ì ì¥ íŒ€ ì¼ì •í‘œ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; }
        
        /* ê³µíœ´ì¼ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .fc-day-sun a { color: #ef4444 !important; } 
        .fc-day-sat a { color: #3b82f6 !important; }
        .holiday-cell { background-color: #fff1f2 !important; }
        .holiday-label { color: #e11d48 !important; font-weight: 800 !important; font-size: 0.75rem !important; margin-top: 2px; }
        
        /* íŒ€ì› ì¹´ë“œ ëŒ€ì‹œë³´ë“œ */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .member-card { background: white; padding: 12px; border-radius: 12px; border-top: 4px solid #059669; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        /* ë‹¬ë ¥ ì»¤ìŠ¤í…€ */
        #calendar { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        .fc-header-toolbar { margin-bottom: 1.5rem !important; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-emerald-600 p-2 rounded-lg shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">í•˜ë‚˜ìƒëª… ì´ì •í™” ì§€ì ì¥ íŒ€ ê·¼ë¬´ ì¼ì •í‘œ</h1>
            </div>
            
            <div id="team-status" class="status-grid">
                </div>
        </header>

        <div id="calendar"></div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800" id="modal-title">ìŠ¤ì¼€ì¤„ ê´€ë¦¬</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">ì„ íƒëœ ë‚ ì§œ</label>
                    <input type="text" id="selected-date" class="w-full bg-slate-50 border-none p-3 rounded-xl text-slate-600 font-medium" readonly>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">ë‹´ë‹¹ ë§¤ë‹ˆì €</label>
                    <select id="user-select" class="w-full border border-slate-200 p-3 rounded-xl focus:ring-4 focus:ring-emerald-500/20 outline-none transition-all cursor-pointer">
                        </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">ì¼ì • êµ¬ë¶„</label>
                    <select id="event-type" class="w-full border border-slate-200 p-3 rounded-xl focus:ring-4 focus:ring-emerald-500/20 outline-none transition-all cursor-pointer">
                        <option value="ì—°ì°¨">ğŸ–ï¸ ì—°ì°¨ (-1ì¼)</option>
                        <option value="ì—¬ë¦„íœ´ê°€">â˜€ï¸ ì—¬ë¦„íœ´ê°€ (-1ì¼)</option>
                        <option value="ë°˜ì°¨">ğŸŒ— ë°˜ì°¨ (-0.5ì¼)</option>
                        <option value="ì™¸ê·¼">ğŸ’¼ ì™¸ê·¼ (ì°¨ê°ì—†ìŒ)</option>
                    </select>
                </div>

                <div class="flex gap-3 pt-4">
                    <button id="btn-delete" onclick="deleteEvent()" class="hidden flex-1 py-3 bg-rose-50 text-rose-600 rounded-xl font-bold hover:bg-rose-100 transition">ì‚­ì œ</button>
                    <button id="btn-save" onclick="saveEvent()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const teamMembers = ["ì´ì—°íƒ", "ë°•ìŠ¹í˜„", "ê°•ë¯¸í˜„", "ê¹€ìš©ì£¼", "ì •í˜œì •", "ê°•ì„ ê²½"];
        const POSITION = "ì„¤ê³„ë§¤ë‹ˆì €";
        const TOTAL_LEAVE = 15;
        
        let events = JSON.parse(localStorage.getItem('hanaCalendarEvents_v2')) || [];
        let holidays = [];
        let calendar;
        let selectedInfo = null;
        let isEditMode = false;

        // 1. í•œêµ­ ê³µíœ´ì¼ ìë™ í˜ì¹­ (Open API í™œìš©)
        async function fetchHolidays(year) {
            try {
                // nager.at APIëŠ” í•œêµ­ ê³µíœ´ì¼(ìŒë ¥ í¬í•¨)ì„ ê½¤ ì •í™•í•˜ê²Œ ë°˜í™˜í•©ë‹ˆë‹¤.
                const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/KR`);
                const data = await response.json();
                return data.map(h => ({
                    title: h.localName,
                    start: h.date,
                    display: 'block',
                    classNames: ['holiday-label'],
                    backgroundColor: 'transparent',
                    textColor: '#e11d48',
                    isHoliday: true
                }));
            } catch (error) {
                console.error("ê³µíœ´ì¼ ë¡œë”© ì‹¤íŒ¨:", error);
                return [];
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // í˜„ì¬ ë…„ë„ì™€ ë‚´ë…„ ê³µíœ´ì¼ ë¯¸ë¦¬ ê°€ì ¸ì˜¤ê¸°
            const currentYear = new Date().getFullYear();
            const h1 = await fetchHolidays(currentYear);
            const h2 = await fetchHolidays(currentYear + 1);
            holidays = [...h1, ...h2];

            initUserSelect();
            renderStatus();

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                headerToolbar: { left: 'today prev,next', center: 'title', right: 'dayGridMonth' },
                events: [...holidays, ...events],
                dayCellDidMount: function(info) {
                    const dateStr = info.date.toISOString().split('T')[0];
                    if (holidays.some(h => h.start === dateStr)) {
                        info.el.classList.add('holiday-cell');
                    }
                },
                dateClick: function(info) {
                    openModal(info.dateStr);
                },
                eventClick: function(info) {
                    if (info.event.extendedProps.isHoliday) return;
                    openEditModal(info.event);
                }
            });
            calendar.render();
        });

        // íŒ€ì› ì„ íƒ ì„¸íŒ…
        function initUserSelect() {
            const select = document.getElementById('user-select');
            teamMembers.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = `${name} ${POSITION}`;
                select.appendChild(opt);
            });
        }

        // í˜„í™©íŒ ê°€ì‹œì„± ê°œì„  (ì—¬ë¦„íœ´ê°€ í¬í•¨ ë¡œì§)
        function renderStatus() {
            const statusEl = document.getElementById('team-status');
            statusEl.innerHTML = '';
            
            teamMembers.forEach(name => {
                const usedCount = events
                    .filter(e => e.name === name)
                    .reduce((acc, curr) => acc + (parseFloat(curr.deduction) || 0), 0);

                const div = document.createElement('div');
                div.className = "member-card";
                div.innerHTML = `
                    <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">${POSITION}</div>
                    <div class="text-base font-black text-slate-800 mb-2">${name}</div>
                    <div class="flex flex-col">
                        <span class="text-xs text-slate-500">ì”ì—¬ ì—°ì°¨</span>
                        <span class="text-lg font-black ${TOTAL_LEAVE - usedCount < 3 ? 'text-rose-600' : 'text-emerald-600'}">
                            ${TOTAL_LEAVE - usedCount} <small class="text-xs">/ ${TOTAL_LEAVE}</small>
                        </span>
                    </div>
                `;
                statusEl.appendChild(div);
            });
        }

        // ëª¨ë‹¬ ì œì–´ ë¡œì§
        function openModal(date) {
            isEditMode = false;
            selectedInfo = { date: date };
            document.getElementById('modal-title').innerText = "ìƒˆ ì¼ì • ë“±ë¡";
            document.getElementById('selected-date').value = date;
            document.getElementById('btn-delete').classList.add('hidden');
            document.getElementById('modal').classList.remove('hidden');
        }

        function openEditModal(eventObj) {
            isEditMode = true;
            selectedInfo = eventObj;
            document.getElementById('modal-title').innerText = "ì¼ì • ìˆ˜ì • ë° ì‚­ì œ";
            document.getElementById('selected-date').value = eventObj.startStr;
            document.getElementById('user-select').value = eventObj.extendedProps.name;
            document.getElementById('event-type').value = eventObj.extendedProps.type;
            document.getElementById('btn-delete').classList.remove('hidden');
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveEvent() {
            const name = document.getElementById('user-select').value;
            const type = document.getElementById('event-type').value;
            let deduction = 0;
            
            // ì—¬ë¦„íœ´ê°€ë„ ë™ì¼í•˜ê²Œ ì—°ì°¨ì—ì„œ ì°¨ê° (15ì¼ ê¸°ì¤€)
            if (type === "ì—°ì°¨" || type === "ì—¬ë¦„íœ´ê°€") deduction = 1;
            else if (type === "ë°˜ì°¨") deduction = 0.5;

            const newEvent = {
                id: isEditMode ? selectedInfo.id : String(Date.now()),
                title: `${name.substring(0,3)} (${type})`,
                start: isEditMode ? selectedInfo.startStr : selectedInfo.date,
                allDay: true,
                color: type === 'ì™¸ê·¼' ? '#64748b' : (type === 'ì—¬ë¦„íœ´ê°€' ? '#f59e0b' : '#059669'),
                name: name,
                type: type,
                deduction: deduction
            };

            if (isEditMode) {
                events = events.filter(e => e.id !== selectedInfo.id);
            }
            
            events.push(newEvent);
            updateAndRefresh();
            closeModal();
        }

        function deleteEvent() {
            if (confirm("ì •ë§ ì´ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?")) {
                events = events.filter(e => e.id !== selectedInfo.id);
                updateAndRefresh();
                closeModal();
            }
        }

        function updateAndRefresh() {
            localStorage.setItem('hanaCalendarEvents_v2', JSON.stringify(events));
            calendar.removeAllEvents();
            calendar.addEventSource(holidays);
            calendar.addEventSource(events);
            renderStatus();
        }
    </script>
</body>
</html>
