<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>하나생명 이정화 지점장 팀 일정표</title>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f4f7fa; }
        
        /* 1. 공휴일 및 일요일 빨간색 처리 */
        .fc-day-sun a, .is-holiday a { color: #ef4444 !important; } 
        .fc-day-sat a { color: #3b82f6 !important; }
        .holiday-cell { background-color: #fff1f2 !important; }
        .holiday-label { color: #e11d48 !important; font-weight: 800 !important; font-size: 0.75rem !important; }
        
        /* 대시보드 및 카드 */
        .member-card { background: white; padding: 15px; border-radius: 12px; border-top: 4px solid #10b981; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.2s; }
        .member-card:hover { transform: translateY(-3px); }

        /* 달력 스타일 커스텀 */
        #calendar { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; }
        .fc-event { border: none !important; padding: 2px 5px !important; font-size: 0.85rem !important; font-weight: 600 !important; cursor: pointer; }
        .fc-toolbar-title { font-size: 1.25rem !important; font-weight: 800 !important; color: #1e293b; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-slate-800 p-2.5 rounded-xl shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                </div>
                <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">하나생명 이정화 지점장 팀 근무 일정표</h1>
            </div>
            
            <div id="team-status" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                </div>
        </header>

        <div id="calendar"></div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[1000]">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md mx-4 border border-slate-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800" id="modal-title">근무 기록</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">날짜 선택</label>
                    <input type="date" id="selected-date" onchange="syncCalendarView(this.value)" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-slate-700 font-bold outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">담당 매니저</label>
                    <select id="user-select" class="w-full border border-slate-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">구분</label>
                    <select id="event-type" onchange="toggleOutsideWork(this.value)" class="w-full border border-slate-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="연차">연차 (-1일)</option>
                        <option value="여름휴가">여름휴가 (-1일)</option>
                        <option value="반차">반차 (-0.5일)</option>
                        <option value="외근">외근</option>
                    </select>
                </div>

                <div id="outside-detail-container" class="hidden animate-fade-in">
                    <label class="block text-xs font-bold text-blue-500 uppercase mb-1">외근처 선택</label>
                    <select id="outside-location" class="w-full border-2 border-blue-100 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50">
                        <option value="삼성금융파트너스">삼성금융파트너스</option>
                        <option value="아이에프에이">아이에프에이</option>
                        <option value="에이원금융판매">에이원금융판매</option>
                        <option value="키움에셋플래너">키움에셋플래너</option>
                        <option value="에이티에셋">에이티에셋</option>
                    </select>
                </div>

                <div class="flex gap-3 pt-6">
                    <button id="btn-delete" onclick="deleteEvent()" class="hidden flex-1 py-3.5 bg-rose-50 text-rose-600 rounded-2xl font-bold hover:bg-rose-100 transition">삭제</button>
                    <button id="btn-save" onclick="saveEvent()" class="flex-1 py-3.5 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 shadow-xl transition">기록 저장</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const teamMembers = ["이연택", "박승현", "강미현", "김용주", "정혜정", "강선경"];
        const POSITION = "설계매니저";
        const TOTAL_LEAVE = 15;
        
        let events = JSON.parse(localStorage.getItem('hana_events_v3')) || [];
        let holidays = [];
        let calendar;
        let selectedInfo = null;
        let isEditMode = false;

        // 공휴일 API 호출 (날짜 밀림 방지를 위한 로직 수정)
        async function fetchHolidays(year) {
            try {
                const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/KR`);
                const data = await response.json();
                return data.map(h => ({
                    title: h.localName,
                    start: h.date, // YYYY-MM-DD 포맷 그대로 사용
                    display: 'block',
                    classNames: ['holiday-label'],
                    backgroundColor: 'transparent',
                    textColor: '#e11d48',
                    isHoliday: true
                }));
            } catch (error) { return []; }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const currentYear = new Date().getFullYear();
            holidays = [...await fetchHolidays(currentYear), ...await fetchHolidays(currentYear + 1)];

            initUserSelect();
            renderStatus();

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                // 주 단위 보기 기능 복구 (dayGridWeek 추가)
                headerToolbar: { left: 'today prev,next', center: 'title', right: 'dayGridMonth,dayGridWeek' },
                events: [...holidays, ...events],
                dayCellDidMount: function(info) {
                    // 로컬 날짜 기준으로 공휴일 체크 (밀림 방지)
                    const dateStr = info.date.toLocaleDateString('en-CA'); 
                    if (holidays.some(h => h.start === dateStr)) {
                        info.el.classList.add('holiday-cell', 'is-holiday');
                    }
                },
                dateClick: function(info) { openModal(info.dateStr); },
                eventClick: function(info) {
                    if (info.event.extendedProps.isHoliday) return;
                    openEditModal(info.event);
                }
            });
            calendar.render();
        });

        function initUserSelect() {
            const select = document.getElementById('user-select');
            teamMembers.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = `${name} ${POSITION}`;
                select.appendChild(opt);
            });
        }

        function renderStatus() {
            const statusEl = document.getElementById('team-status');
            statusEl.innerHTML = '';
            teamMembers.forEach(name => {
                const used = events.filter(e => e.name === name).reduce((acc, curr) => acc + (parseFloat(curr.deduction) || 0), 0);
                const div = document.createElement('div');
                div.className = "member-card";
                div.innerHTML = `
                    <div class="text-[10px] text-slate-400 font-bold mb-1">${POSITION}</div>
                    <div class="text-sm font-black text-slate-800 mb-1">${name}</div>
                    <div class="text-xs font-bold text-emerald-600">잔여: ${TOTAL_LEAVE - used}일</div>
                `;
                statusEl.appendChild(div);
            });
        }

        // 외근 선택 시 상세 선택지 노출
        function toggleOutsideWork(val) {
            const container = document.getElementById('outside-detail-container');
            if (val === "외근") container.classList.remove('hidden');
            else container.classList.add('hidden');
        }

        // 날짜 입력 시 달력 이동
        function syncCalendarView(date) {
            if (date) calendar.gotoDate(date);
        }

        function openModal(date) {
            isEditMode = false;
            document.getElementById('modal-title').innerText = "새 일정 등록";
            document.getElementById('selected-date').value = date;
            document.getElementById('event-type').value = "연차";
            toggleOutsideWork("연차");
            document.getElementById('btn-delete').classList.add('hidden');
            document.getElementById('modal').classList.remove('hidden');
        }

        function openEditModal(eventObj) {
            isEditMode = true;
            selectedInfo = eventObj;
            document.getElementById('modal-title').innerText = "기록 수정";
            document.getElementById('selected-date').value = eventObj.startStr;
            document.getElementById('user-select').value = eventObj.extendedProps.name;
            document.getElementById('event-type').value = eventObj.extendedProps.type;
            
            toggleOutsideWork(eventObj.extendedProps.type);
            if(eventObj.extendedProps.type === "외근") {
                document.getElementById('outside-location').value = eventObj.extendedProps.location;
            }
            
            document.getElementById('btn-delete').classList.remove('hidden');
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveEvent() {
            const name = document.getElementById('user-select').value;
            const type = document.getElementById('event-type').value;
            const date = document.getElementById('selected-date').value;
            const location = document.getElementById('outside-location').value;
            let deduction = 0;
            
            if (type === "연차" || type === "여름휴가") deduction = 1;
            else if (type === "반차") deduction = 0.5;

            // 달력 표기 텍스트 설정
            let displayTitle = `${name.substring(0,3)} (${type})`;
            if (type === "외근") displayTitle = `${name.substring(0,3)} [${location}]`;

            const newEvent = {
                id: isEditMode ? selectedInfo.id : String(Date.now()),
                title: displayTitle,
                start: date,
                allDay: true,
                color: type === '외근' ? '#3b82f6' : (type === '여름휴가' ? '#f59e0b' : '#10b981'),
                name, type, deduction, location: type === "외근" ? location : ""
            };

            if (isEditMode) events = events.filter(e => e.id !== selectedInfo.id);
            events.push(newEvent);
            
            localStorage.setItem('hana_events_v3', JSON.stringify(events));
            calendar.removeAllEvents();
            calendar.addEventSource(holidays);
            calendar.addEventSource(events);
            renderStatus();
            closeModal();
        }

        function deleteEvent() {
            if (confirm("삭제하시겠습니까?")) {
                events = events.filter(e => e.id !== selectedInfo.id);
                localStorage.setItem('hana_events_v3', JSON.stringify(events));
                calendar.removeAllEvents();
                calendar.addEventSource(holidays);
                calendar.addEventSource(events);
                renderStatus();
                closeModal();
            }
        }
    </script>
</body>
</html>
